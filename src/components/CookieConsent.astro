---
const siteName = import.meta.env.PUBLIC_SITE_NAME ?? "Zenovee LLC";
---

<div
  id="zenCookieBanner"
  class="fixed inset-x-0 bottom-0 z-50 hidden p-4 sm:p-6"
  role="dialog"
  aria-label="Cookie consent"
  aria-live="polite"
  transition:persist
>
  <div class="mx-auto w-full max-w-4xl rounded-2xl border border-white/10 bg-zinc-950/95 p-4 shadow-glow backdrop-blur sm:p-5">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
      <div class="max-w-2xl">
        <div class="text-sm font-semibold text-white/90">Cookies &amp; privacy</div>
        <p class="mt-2 text-sm text-white/70">
          {siteName} uses cookies to run this site and, with your consent, to measure performance and improve the experience.
          Read our <a class="text-white/80 hover:text-white" href="/legal/cookie-policy">Cookie Policy</a> and
          <a class="text-white/80 hover:text-white" href="/legal/privacy-policy">Privacy Policy</a>.
        </p>
      </div>

      <div class="flex flex-col gap-2 sm:min-w-[240px]">
        <button id="zenCookieAccept" class="btn btn-primary w-full" type="button">Accept all</button>
        <button id="zenCookieReject" class="btn btn-secondary w-full" type="button">Reject non-essential</button>
        <button id="zenCookieCustomize" class="btn btn-ghost w-full" type="button">Customize</button>
      </div>
    </div>

    <div id="zenCookiePrefs" class="mt-4 hidden rounded-2xl border border-white/10 bg-white/[0.03] p-4">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <div class="text-sm font-semibold text-white/85">Optional cookies</div>
          <div class="mt-1 text-sm text-white/65">Essential cookies are always on. Choose whether to allow analytics.</div>
        </div>
        <button id="zenCookieSave" class="btn btn-primary sm:w-auto" type="button">Save preferences</button>
      </div>

      <div class="mt-4 grid gap-3">
        <label class="flex items-start justify-between gap-3 rounded-2xl border border-white/10 bg-black/20 px-4 py-3">
          <div>
            <div class="text-sm font-semibold text-white/85">Analytics</div>
            <div class="mt-1 text-xs text-white/60">Helps us understand visits and improve pages.</div>
          </div>
          <input
            id="zenCookieAnalytics"
            type="checkbox"
            class="mt-1 h-4 w-4 accent-brand-400"
            aria-label="Allow analytics cookies"
          />
        </label>
      </div>

      <p class="mt-3 text-xs text-white/50">
        You can change your choices any time using the “Cookie settings” link in the footer.
      </p>
    </div>
  </div>
</div>

<script is:inline>
  (() => {
    const STORAGE_KEY = "zenovee_cookie_consent_v1";
    const DEFAULT = { analytics: false, updatedAt: "" };

    const read = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch {
        return null;
      }
    };

    const setGlobal = (consent) => {
      window.__zenoveeCookieConsent = consent;
      window.dispatchEvent(new CustomEvent("zenovee:cookie-consent-updated", { detail: consent }));
    };

    const write = (partial) => {
      const value = { ...DEFAULT, ...(partial || {}), updatedAt: new Date().toISOString() };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(value));
      setGlobal(value);
      return value;
    };

    const getEls = () => {
      const banner = document.getElementById("zenCookieBanner");
      const prefs = document.getElementById("zenCookiePrefs");
      const accept = document.getElementById("zenCookieAccept");
      const reject = document.getElementById("zenCookieReject");
      const customize = document.getElementById("zenCookieCustomize");
      const save = document.getElementById("zenCookieSave");
      const analytics = document.getElementById("zenCookieAnalytics");
      if (!banner || !prefs || !accept || !reject || !customize || !save || !analytics) return null;
      return { banner, prefs, accept, reject, customize, save, analytics };
    };

    const show = () => {
      const els = getEls();
      if (!els) return;
      els.banner.classList.remove("hidden");
    };

    const hide = () => {
      const els = getEls();
      if (!els) return;
      els.prefs.classList.add("hidden");
      els.banner.classList.add("hidden");
    };

    const openPrefs = () => {
      const els = getEls();
      if (!els) return;
      const existing = read() || DEFAULT;
      els.analytics.checked = Boolean(existing.analytics);
      els.banner.classList.remove("hidden");
      els.prefs.classList.remove("hidden");
    };

    const init = () => {
      const els = getEls();
      if (!els) return;
      const { banner, prefs, accept, reject, customize, save, analytics } = els;

      if (banner.dataset.bound === "1") return;
      banner.dataset.bound = "1";

      const existing = read();
      if (existing) {
        setGlobal(existing);
        hide();
      } else {
        setGlobal(DEFAULT);
        show();
      }

      accept.addEventListener("click", () => {
        write({ analytics: true });
        hide();
      });
      reject.addEventListener("click", () => {
        write({ analytics: false });
        hide();
      });
      customize.addEventListener("click", () => {
        const existingNow = read() || DEFAULT;
        analytics.checked = Boolean(existingNow.analytics);
        prefs.classList.toggle("hidden");
      });
      save.addEventListener("click", () => {
        write({ analytics: analytics.checked });
        hide();
      });

      // Global "cookie settings" trigger (e.g. footer link)
      document.addEventListener("click", (e) => {
        const t = e.target?.closest?.("[data-cookie-preferences]");
        if (!t) return;
        e.preventDefault?.();
        openPrefs();
      });
    };

    if (!window.__zenoveeCookieConsentBound) {
      window.__zenoveeCookieConsentBound = true;
      document.addEventListener("astro:page-load", init);
      document.addEventListener("astro:after-swap", init);
    }
    init();
  })();
</script>

